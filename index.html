<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0066B2">
    <title>VIVES Reparto</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f8f8fa;
            --text-primary: #1a1a1f;
            --text-secondary: #6b6b75;
            --text-muted: #9d9da6;
            --accent-blue: #0066B2;
            --accent-green: #34c759;
            --accent-orange: #ff9500;
            --accent-red: #E53935;
            --border-color: #e5e5ea;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
            --header-bg: #0066B2;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .header {
            background: var(--header-bg);
            color: white;
            padding: 12px 20px;
            padding-top: max(12px, env(safe-area-inset-top));
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title-area {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 0;
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .header-date {
            font-size: 0.9rem;
            opacity: 0.85;
        }

        .header-arrow {
            font-size: 0.7rem;
            opacity: 0.7;
            transition: transform 0.2s;
        }

        .header-arrow.open {
            transform: rotate(180deg);
        }

        .filtro-dropdown {
            display: none;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            margin-top: 10px;
            padding: 8px;
        }

        .filtro-dropdown.visible {
            display: block;
        }

        .filtro-option {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .filtro-option:active {
            background: rgba(255,255,255,0.2);
        }

        .filtro-option.active {
            background: rgba(255,255,255,0.25);
            font-weight: 600;
        }

        .user-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 180px;
            overflow: hidden;
            z-index: 200;
            margin-top: 8px;
        }

        .user-menu.visible {
            display: block;
        }

        .user-menu-option {
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-menu-option:active {
            background: var(--bg-primary);
        }

        .user-menu-option.logout {
            color: var(--accent-red);
            border-top: 1px solid var(--border-color);
        }

        .user-badge-container {
            position: relative;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .time-group {
            margin-top: 16px;
        }

        .time-header {
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .entrega-card {
            background: var(--bg-card);
            margin: 0 16px 8px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .entrega-row {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            gap: 10px;
            cursor: pointer;
        }

        .status-icon {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            flex-shrink: 0;
            cursor: pointer;
            color: white;
            margin-top: 4px;
        }

        .status-icon:active { transform: scale(0.9); }
        .status-icon.pagado { background: var(--accent-blue); }
        .status-icon.cobrar { background: var(--accent-red); }

        .repartidor-icon {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            flex-shrink: 0;
            cursor: pointer;
            color: white;
            background: var(--accent-red);
            margin-top: 4px;
        }

        .repartidor-icon:active { transform: scale(0.9); }
        .repartidor-icon svg { width: 24px; height: 24px; fill: white; }

        .entrega-info { flex: 1; min-width: 0; }
        .cliente-nombre { font-weight: 600; font-size: 0.95rem; color: var(--accent-blue); margin-bottom: 2px; }
        .cliente-direccion { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); line-height: 1.3; }
        .cliente-vendedor { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
        .observaciones-preview { font-size: 0.8rem; color: var(--accent-red); font-weight: 500; margin-top: 4px; white-space: normal; word-wrap: break-word; }

        .articulos-preview {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }

        .articulo-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
        }

        .articulo-almacen-mini {
            background: var(--accent-blue);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            flex-shrink: 0;
            cursor: pointer;
        }

        .articulo-almacen-mini:active {
            transform: scale(0.9);
        }

        .articulo-nombre-mini {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
        }
        .arrow-icon { color: var(--text-muted); font-size: 1.2rem; }

        .detail-view, .producto-detail-view {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            z-index: 200;
            overflow-y: auto;
            padding-bottom: 100px;
        }
        .detail-view.active, .producto-detail-view.active { display: block; }
        .producto-detail-view { z-index: 300; }

        .detail-header {
            background: var(--header-bg);
            color: white;
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
        }

        .detail-header-text { flex: 1; text-align: center; font-weight: 600; }
        .detail-content, .producto-detail-content { padding: 20px; }
        .detail-location { text-align: center; margin-bottom: 20px; }
        .detail-zona { font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; }
        .detail-direccion { font-size: 1.4rem; font-weight: 700; margin: 8px 0; cursor: pointer; }
        .detail-direccion:active { color: var(--accent-blue); }
        .detail-cliente { font-size: 1.1rem; color: var(--accent-blue); font-weight: 600; }
        .detail-telefono { font-size: 1.3rem; font-weight: 600; margin-top: 12px; font-family: 'JetBrains Mono', monospace; cursor: pointer; }
        .detail-telefono:active { color: var(--accent-blue); }
        .detail-vendedor { font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px; }

        .btn-glide {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: var(--accent-blue);
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            margin: 12px 0;
            border: none;
            width: 100%;
            cursor: pointer;
            font-family: inherit;
        }
        .btn-glide:active { transform: scale(0.98); }
        .btn-glide svg { width: 20px; height: 20px; stroke: currentColor; fill: none; }
        .btn-glide.btn-foto { background: #f0f0f0; color: var(--text-secondary); }

        .producto-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        .producto-header { display: flex; align-items: center; gap: 12px; }

        .producto-almacen-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background: var(--accent-blue);
            flex-shrink: 0;
        }

        .producto-info-row { flex: 1; }
        .producto-qty { font-size: 0.85rem; color: var(--accent-blue); font-weight: 600; }
        .cantidad-multiple { color: var(--accent-red); font-weight: 700; }
        .producto-nombre { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }

        .observaciones-box {
            background: #fff3e0;
            border-left: 4px solid var(--accent-orange);
            padding: 12px 16px;
            border-radius: 0 12px 12px 0;
            margin: 16px 0;
            font-size: 0.9rem;
        }

        .notas-section { margin: 20px 0; }
        .notas-label { font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; }
        .notas-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            background: var(--bg-card);
        }

        .producto-detail-content { text-align: center; }
        .producto-detail-qty { font-size: 1.5rem; color: var(--text-secondary); margin-bottom: 8px; }
        .producto-detail-nombre { font-size: 1.4rem; font-weight: 700; color: var(--accent-blue); margin-bottom: 16px; }
        .producto-detail-almacen { font-size: 1rem; margin-bottom: 8px; }
        .producto-detail-info { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; }

        .almacen-selector { display: flex; justify-content: center; gap: 10px; margin: 24px 0; flex-wrap: wrap; }
        .almacen-btn {
            width: 52px; height: 52px;
            border-radius: 10px;
            border: none;
            background: var(--accent-blue);
            color: white;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            opacity: 0.4;
        }
        .almacen-btn.active { opacity: 1; transform: scale(1.1); }

        .foto-preview { max-width: 100%; border-radius: 12px; margin: 16px 0; }

        .foto-status {
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            margin: 12px 0;
            text-align: center;
        }
        
        .foto-ok {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .foto-subiendo {
            background: #fff3e0;
            color: #e65100;
        }
        
        .foto-pendiente {
            background: #ffebee;
            color: #c62828;
        }

        .foto-visor {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .foto-visor.active {
            display: flex;
        }

        .foto-visor img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            touch-action: pinch-zoom;
        }

        .foto-visor-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10000;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 400;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; width: 100%; max-width: 320px; }
        .modal-title { font-size: 1.2rem; font-weight: 700; text-align: center; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 14px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 1.2rem; text-align: center; font-family: 'JetBrains Mono', monospace; margin-bottom: 16px; }
        .modal-buttons { display: flex; gap: 12px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; font-family: inherit; }
        .modal-btn.cancel { background: var(--bg-primary); color: var(--text-secondary); }
        .modal-btn.confirm { background: var(--accent-blue); color: white; }

        .tab-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            border-top: 1px solid var(--border-color);
            z-index: 100;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            padding: 4px 16px;
            font-family: inherit;
        }
        .tab-item.active { color: var(--accent-blue); }
        .tab-item svg { width: 24px; height: 24px; }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }

        .upload-section {
            padding: 40px 20px;
            text-align: center;
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .upload-area {
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 350px;
            cursor: pointer;
        }
        .upload-area:active { border-color: var(--accent-blue); }
        .upload-area svg { width: 48px; height: 48px; color: var(--accent-blue); margin-bottom: 16px; }
        .upload-area h3 { font-size: 1.1rem; margin-bottom: 8px; }
        .upload-area p { color: var(--text-secondary); font-size: 0.9rem; }

        #fileInput, #cameraInput { display: none; }

        .sync-indicator {
            position: fixed;
            top: 70px; right: 16px;
            background: var(--accent-orange);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: none;
            z-index: 150;
            cursor: pointer;
        }
        .sync-indicator.visible { display: block; }

        .login-view {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0066B2 0%, #004080 100%);
            z-index: 500;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .login-view.active { display: flex; }
        .login-container { width: 100%; max-width: 340px; }
        .login-logo { text-align: center; color: white; margin-bottom: 40px; }
        .login-icon { font-size: 4rem; margin-bottom: 16px; }
        .login-logo h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; }
        .login-logo p { opacity: 0.85; font-size: 1rem; }
        .login-step { display: flex; flex-direction: column; gap: 12px; }
        .login-input { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1.1rem; font-family: inherit; text-align: center; }
        .login-input.pin-input { font-size: 1.8rem; letter-spacing: 8px; font-family: 'JetBrains Mono', monospace; }
        .login-submit-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; font-family: inherit; background: white; color: var(--accent-blue); }
        .login-submit-btn:active { transform: scale(0.98); }
        .login-submit-btn:disabled { opacity: 0.6; }
        .login-back-btn { background: transparent; border: none; color: white; font-size: 0.95rem; cursor: pointer; padding: 12px; font-family: inherit; opacity: 0.85; }
        .login-info { color: white; text-align: center; font-size: 0.85rem; opacity: 0.75; margin-top: 8px; }
        .login-email-sent { color: white; text-align: center; font-size: 0.95rem; margin-bottom: 8px; }
        .login-error { color: #ffcdd2; text-align: center; font-size: 0.9rem; margin-top: 16px; min-height: 24px; }

        .importe-cobrado { background: #e8f5e9; border-radius: 8px; padding: 10px 16px; margin: 12px 0; font-size: 0.9rem; color: #2e7d32; display: flex; justify-content: space-between; }
        .importe-cobrado strong { font-family: 'JetBrains Mono', monospace; }

        .scanner-section { padding: 16px; text-align: center; }
        .scanner-section h3 { font-size: 1.1rem; margin-bottom: 4px; color: var(--text-primary); }
        .scanner-hint { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px; }
        #scanner-container { width: 100%; max-width: 300px; height: 300px; margin: 0 auto 16px; border-radius: 12px; overflow: hidden; background: #000; }
        #scanner-container video { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }
        .resultado-encontrado { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px; padding: 16px; margin-top: 16px; text-align: left; }
        .resultado-encontrado h4 { color: #2e7d32; margin-bottom: 8px; }
        .resultado-no-encontrado { background: #ffebee; border: 2px solid #f44336; border-radius: 12px; padding: 16px; margin-top: 16px; }
        .resultado-no-encontrado h4 { color: #c62828; }
        .resultado-info { font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; }
        .resultado-cliente { font-weight: 600; color: var(--accent-blue); }
        .resultado-articulo { font-size: 1rem; font-weight: 600; margin: 8px 0; }

        .scanner-divider {
            height: 1px;
            background: var(--border-color);
            margin: 20px 0;
        }

        .btn-modelo {
            background: var(--accent-orange) !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="header-row">
                <div class="header-title-area" onclick="toggleFiltroDropdown()">
                    <span class="header-title">Reparto</span>
                    <span class="header-date" id="headerDate"></span>
                    <span class="header-arrow">‚ñº</span>
                </div>
                <div class="user-badge-container">
                    <div class="user-badge" onclick="toggleUserMenu()" id="userBadge">
                        <span id="userBadgeName">Usuario</span>
                    </div>
                    <div class="user-menu" id="userMenu">
                        <div class="user-menu-option" onclick="actualizarDatos()">üîÑ Actualizar datos</div>
                        <div class="user-menu-option logout" onclick="logout()">üö™ Cerrar sesi√≥n</div>
                    </div>
                </div>
            </div>
            <div class="filtro-dropdown" id="filtroDropdown"></div>
        </header>

        <div class="sync-indicator" id="syncIndicator">‚è≥ Sincronizando...</div>

        <main id="mainContent">
            <div class="upload-section">
                <div class="upload-area" onclick="cargarDatosDesdesheets()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <h3>Cargar datos de reparto</h3>
                    <p>Pulsa para sincronizar con Google Sheets</p>
                </div>
            </div>
        </main>

        <nav class="tab-bar">
            <button class="tab-item active" onclick="showTab('reparto')" id="tabReparto">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                Reparto
            </button>
            <button class="tab-item" onclick="showTab('lista')" id="tabLista">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h10"/><rect x="18" y="14" width="4" height="6" rx="1"/></svg>
                Esc√°ner
            </button>
            <button class="tab-item" onclick="showTab('terminados')" id="tabTerminados">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Terminados
            </button>
            <button class="tab-item" onclick="showTab('servicios')" id="tabServicios">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                Servicios
            </button>
        </nav>
    </div>

    <div class="detail-view" id="detailView">
        <div class="detail-header">
            <button class="back-btn" onclick="closeDetail()">‚Üê</button>
            <div class="detail-header-text" id="detailHeaderText"></div>
            <div style="width: 32px;"></div>
        </div>
        <div class="detail-content" id="detailContent"></div>
    </div>

    <div class="producto-detail-view" id="productoDetailView">
        <div class="detail-header">
            <button class="back-btn" onclick="closeProductoDetail()">‚Üê</button>
            <div class="detail-header-text">Detalle producto</div>
            <div style="width: 32px;"></div>
        </div>
        <div class="producto-detail-content" id="productoDetailContent"></div>
    </div>

    <div class="foto-visor" id="fotoVisor" onclick="cerrarVisorFoto()">
        <div class="foto-visor-close">‚úï</div>
        <img id="fotoVisorImg" src="" alt="Foto">
    </div>

    <div class="modal-overlay" id="cobroModal">
        <div class="modal-content">
            <div class="modal-title">Importe cobrado</div>
            <input type="number" class="modal-input" id="cobroInput" placeholder="0.00" step="0.01">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="cerrarModalCobro()">Cancelar</button>
                <button class="modal-btn confirm" onclick="confirmarCobro()">Confirmar</button>
            </div>
        </div>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handlePhoto(event)">

    <div class="login-view active" id="loginView">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-icon">üöö</div>
                <h1>VIVES Reparto</h1>
                <p>Introduce tu email</p>
            </div>
            <div class="login-step" id="stepEmail">
                <input type="email" id="emailInput" class="login-input" placeholder="tu@email.com" onkeypress="if(event.key==='Enter')solicitarPIN()">
                <button class="login-submit-btn" onclick="solicitarPIN()" id="btnSolicitarPIN">Enviar c√≥digo</button>
                <p class="login-info">Te enviaremos un c√≥digo de acceso</p>
            </div>
            <div class="login-step" id="stepPIN" style="display:none;">
                <p class="login-email-sent">C√≥digo enviado a <strong id="emailEnviado"></strong></p>
                <input type="tel" id="pinInput" class="login-input pin-input" placeholder="000000" maxlength="6" onkeypress="if(event.key==='Enter')verificarPIN()">
                <button class="login-submit-btn" onclick="verificarPIN()" id="btnVerificarPIN">Verificar c√≥digo</button>
                <button class="login-back-btn" onclick="volverAEmail()">‚Üê Cambiar email</button>
            </div>
            <p class="login-error" id="loginError"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const WEBHOOK_AUTH = 'https://n8n-n8n.qhekde.easypanel.host/webhook/auth-reparto';
        const WEBHOOK_VERIFICAR = 'https://n8n-n8n.qhekde.easypanel.host/webhook/verificar-pin';
        const WEBHOOK_LEER = 'https://n8n-n8n.qhekde.easypanel.host/webhook/leer-reparto';
        const WEBHOOK_GUARDAR = 'https://n8n-n8n.qhekde.easypanel.host/webhook/guardar-cambios';
        const WEBHOOK_FOTO = 'https://n8n-n8n.qhekde.easypanel.host/webhook/subir-foto';
        const WEBHOOK_BORRAR_FOTO = 'https://n8n-n8n.qhekde.easypanel.host/webhook/borrar-foto';
        const WEBHOOK_EXTRAER_MODELO = 'https://n8n-n8n.qhekde.easypanel.host/webhook/extraer-modelo';

        const ESTADOS_PAGO = ['?', '‚úì', '‚Ç¨'];
        const ALMACENES = ['?', 'A', 'T', 'C', 'R'];
        const ALMACEN_NOMBRES = { '?': 'Por definir', 'A': 'Almac√©n', 'R': 'Reservas', 'T': 'Tienda', 'C': 'Celsa' };
        const REPARTIDORES_ENTREGA = ['EQ', 'A', 'S'];

        const SVG_EQUIPO = `<svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>`;
        const SVG_PHONE = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>`;
        const SVG_CHECK = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
        const SVG_CAMERA = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>`;
        const SVG_ERASER = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16l9-9 8 8-4 4z"/><path d="M6.5 13.5L12 8"/></svg>`;
        const SVG_MONEY = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`;
        const SVG_BARCODE = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5v14M7 5v14M10 5v14M14 5v14M17 5v14M21 5v14"/></svg>`;

        let appData = {
            entregas: [], articulos: [], repartidores: [],
            repartidorActual: 'TODOS', tabActual: 'reparto', fecha: null,
            entregaSeleccionada: null, productoSeleccionado: null,
            pendingChanges: [], usuarioActual: null, emailActual: null,
            rolActual: null, entregaParaCobro: null
        };

        function isAdmin() { return appData.rolActual === 'admin'; }
        function puedeEditarPago() { return isAdmin(); }
        function puedeEditarAlmacen() { return isAdmin(); }

        async function solicitarPIN() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            if (!email || !email.includes('@')) { mostrarError('Introduce un email v√°lido'); return; }
            const btn = document.getElementById('btnSolicitarPIN');
            btn.disabled = true; btn.textContent = 'Enviando...'; mostrarError('');
            try {
                const response = await fetch(WEBHOOK_AUTH, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
                const data = await response.json();
                if (data.ok) {
                    document.getElementById('emailEnviado').textContent = email;
                    document.getElementById('stepEmail').style.display = 'none';
                    document.getElementById('stepPIN').style.display = 'flex';
                    document.getElementById('pinInput').focus();
                    appData.emailActual = email;
                } else { mostrarError(data.error || 'Email no autorizado'); }
            } catch (e) { mostrarError('Error de conexi√≥n'); }
            btn.disabled = false; btn.textContent = 'Enviar c√≥digo';
        }

        async function verificarPIN() {
            const pin = document.getElementById('pinInput').value.trim();
            if (!pin || pin.length !== 6) { mostrarError('Introduce el c√≥digo de 6 d√≠gitos'); return; }
            const btn = document.getElementById('btnVerificarPIN');
            btn.disabled = true; btn.textContent = 'Verificando...'; mostrarError('');
            try {
                const response = await fetch(WEBHOOK_VERIFICAR, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: appData.emailActual, pin }) });
                let data = await response.json();
                
                // Si viene como array, tomar el primer elemento
                if (Array.isArray(data)) {
                    data = data[0];
                }
                
                if (data.ok) {
                    appData.usuarioActual = data.email; appData.emailActual = data.email; appData.rolActual = data.rol;
                    localStorage.setItem('vivesRepartoSession', JSON.stringify({ email: data.email, rol: data.rol }));
                    hideLogin(); renderApp();
                } else { mostrarError(data.error || 'PIN incorrecto'); }
            } catch (e) { mostrarError('Error de conexi√≥n'); }
            btn.disabled = false; btn.textContent = 'Verificar c√≥digo';
        }

        function volverAEmail() {
            document.getElementById('stepPIN').style.display = 'none';
            document.getElementById('stepEmail').style.display = 'flex';
            document.getElementById('pinInput').value = ''; mostrarError('');
        }

        function mostrarError(msg) { document.getElementById('loginError').textContent = msg; }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('visible');
        }

        // Cerrar men√∫ al pulsar fuera
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('userMenu');
            const badge = document.getElementById('userBadge');
            if (menu && !menu.contains(e.target) && !badge.contains(e.target)) {
                menu.classList.remove('visible');
            }
        });

        async function actualizarDatos() {
            document.getElementById('userMenu').classList.remove('visible');
            await cargarDatosDesdesheets();
            renderApp();
        }

        function logout() {
            document.getElementById('userMenu').classList.remove('visible');
            if (!confirm('¬øCerrar sesi√≥n?')) return;
            
            appData.usuarioActual = null; appData.emailActual = null; appData.rolActual = null;
            appData.entregas = []; appData.articulos = [];
            localStorage.removeItem('vivesRepartoSession');
            document.getElementById('emailInput').value = '';
            document.getElementById('pinInput').value = '';
            document.getElementById('stepPIN').style.display = 'none';
            document.getElementById('stepEmail').style.display = 'flex';
            mostrarError(''); showLogin();
        }

        function showLogin() { document.getElementById('loginView').classList.add('active'); }
        function hideLogin() { document.getElementById('loginView').classList.remove('active'); }

        function cargarSesion() {
            const session = localStorage.getItem('vivesRepartoSession');
            if (session) {
                const data = JSON.parse(session);
                appData.usuarioActual = data.email; appData.emailActual = data.email; appData.rolActual = data.rol;
                return true;
            }
            return false;
        }

        function saveToLocal() {
            localStorage.setItem('vivesRepartoConfig', JSON.stringify({
                repartidorActual: appData.repartidorActual, tabActual: appData.tabActual, pendingChanges: appData.pendingChanges
            }));
        }

        function loadFromLocal() {
            cargarSesion();
            const config = localStorage.getItem('vivesRepartoConfig');
            if (config) {
                const c = JSON.parse(config);
                appData.repartidorActual = c.repartidorActual || 'TODOS';
                appData.tabActual = c.tabActual || 'reparto';
                appData.pendingChanges = c.pendingChanges || [];
            }
            return appData.usuarioActual !== null;
        }

        let syncInProgress = false;
        
        // Detectar cuando vuelve la conexi√≥n
        window.addEventListener('online', () => {
            console.log('Conexi√≥n recuperada');
            if (appData.pendingChanges.length > 0) {
                sincronizarCambios();
            }
        });
        
        function savePendingChange(change) {
            // Buscar si ya existe un cambio pendiente para el mismo item y tipo
            const existingIndex = appData.pendingChanges.findIndex(c => 
                c.rowNumber === change.rowNumber && c.type === change.type
            );
            
            if (existingIndex >= 0) {
                // Actualizar el cambio existente en lugar de a√±adir uno nuevo
                appData.pendingChanges[existingIndex] = { ...change, timestamp: new Date().toISOString() };
            } else {
                appData.pendingChanges.push({ ...change, timestamp: new Date().toISOString() });
            }
            
            saveToLocal(); 
            updateSyncIndicator();
            
            // Auto-sincronizar despu√©s de 2 segundos sin cambios
            clearTimeout(window.syncTimeout);
            if (!syncInProgress) {
                window.syncTimeout = setTimeout(sincronizarCambios, 2000);
            }
        }

        async function sincronizarCambios() {
            if (appData.pendingChanges.length === 0 || syncInProgress) return;
            
            // Verificar si hay conexi√≥n
            if (!navigator.onLine) {
                updateSyncIndicator();
                return;
            }
            
            syncInProgress = true;
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = '‚è≥ Guardando...';
            indicator.classList.add('visible');
            indicator.onclick = null;
            
            // Copiar los cambios actuales para enviar
            const cambiosAEnviar = [...appData.pendingChanges];
            
            try {
                const response = await fetch(WEBHOOK_GUARDAR, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cambios: cambiosAEnviar })
                });
                
                let data = await response.json();
                if (Array.isArray(data)) data = data[0];
                
                if (data.ok) {
                    // Eliminar solo los cambios que se enviaron
                    appData.pendingChanges = appData.pendingChanges.filter(c => 
                        !cambiosAEnviar.some(e => e.timestamp === c.timestamp)
                    );
                    saveToLocal();
                    
                    if (appData.pendingChanges.length === 0) {
                        indicator.textContent = '‚úì Guardado';
                        setTimeout(() => indicator.classList.remove('visible'), 2000);
                    } else {
                        // Hay m√°s cambios pendientes, sincronizar de nuevo
                        setTimeout(sincronizarCambios, 1000);
                    }
                } else {
                    indicator.textContent = '‚ö†Ô∏è Error - Pulsa para reintentar';
                    indicator.onclick = sincronizarCambios;
                }
            } catch (e) {
                console.error(e);
                indicator.textContent = `‚ö†Ô∏è Sin conexi√≥n (${appData.pendingChanges.length})`;
                indicator.onclick = sincronizarCambios;
                
                // Reintentar en 30 segundos si hay conexi√≥n
                setTimeout(() => {
                    if (navigator.onLine && appData.pendingChanges.length > 0) {
                        sincronizarCambios();
                    }
                }, 30000);
            }
            
            syncInProgress = false;
            
            // Si hay cambios pendientes que se a√±adieron mientras guardaba, sincronizar
            if (appData.pendingChanges.length > 0 && navigator.onLine) {
                window.syncTimeout = setTimeout(sincronizarCambios, 2000);
            }
        }
        
        function updateSyncIndicator() {
            const ind = document.getElementById('syncIndicator');
            if (appData.pendingChanges.length > 0) { 
                ind.classList.add('visible'); 
                if (!navigator.onLine) {
                    ind.textContent = `‚ö†Ô∏è Sin conexi√≥n (${appData.pendingChanges.length} pendientes)`;
                    ind.onclick = sincronizarCambios;
                } else {
                    ind.textContent = `‚è≥ ${appData.pendingChanges.length} cambio(s)`; 
                    ind.onclick = sincronizarCambios;
                }
            }
            else { ind.classList.remove('visible'); }
        }

        function updateSyncIndicator() {
            const ind = document.getElementById('syncIndicator');
            if (appData.pendingChanges.length > 0) { ind.classList.add('visible'); ind.textContent = `‚è≥ ${appData.pendingChanges.length} cambio(s)`; }
            else { ind.classList.remove('visible'); }
        }

        function formatPhone(phone) {
            if (!phone) return null;
            let str = String(phone).replace(/[^0-9+]/g, '');
            if (phone > 1000000000) str = Math.round(phone).toString();
            return str.length >= 9 ? str : null;
        }

        async function cargarDatosDesdesheets() {
            const btn = document.querySelector('.upload-area');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<h3>Cargando...</h3><p>Sincronizando con Google Sheets</p>';
            
            try {
                const response = await fetch(WEBHOOK_LEER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                let data = await response.json();
                
                // Si viene como array, tomar el primer elemento
                if (Array.isArray(data)) {
                    data = data[0];
                }
                
                if (data.ok) {
                    processDataFromSheets(data.reparto, data.lista);
                } else {
                    alert('Error al cargar datos');
                    btn.innerHTML = originalHTML;
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexi√≥n: ' + e.message);
                btn.innerHTML = originalHTML;
            }
        }

        function processDataFromSheets(repData, listData) {
            // Filtrar: reparto son los que tienen VENDEDOR, lista los que tienen C√ìDIGO
            const repartoFiltrado = repData.filter(r => r['VENDEDOR'] && !r['C√ìDIGO']);
            const listaFiltrada = repData.filter(r => r['C√ìDIGO'] || r['ART√çCULO']);
            
            appData.entregas = repartoFiltrado.map((r, i) => ({
                id: `e_${i}`, 
                repartidor: r['REPARTIDOR'] || 'Sin asignar', 
                dia: r['DIA'], 
                hora: r['HORA'] || '',
                documento: r['DOCUMENTO'], 
                cliente: r['CLIENTE'], 
                direccion: r['DIRECCION'], 
                poblacion: r['POBLACION'] || '',
                cp: r['C.P.'] || r['CP'] || '', 
                vendedor: r['VENDEDOR'], 
                observaciones: r['OBSERVACIONES'] || '',
                telefonos: [formatPhone(r['Tel1'] || r['TEL1']), formatPhone(r['Tel2'] || r['TEL2']), formatPhone(r['Tel3'] || r['TEL3'])].filter(t => t),
                estadoPago: r['ESTADO_PAGO'] || '?', 
                quienEntrega: r['INSTALADOR'] || 'EQ', 
                estado: r['ESTADO'] || 'PENDIENTE', 
                notas: r['NOTAS'] || '', 
                importeCobrado: r['IMPORTE_COBRADO'] || null,
                rowNumber: r['row_number']
            }));
            
            // Convertir ALMAC√âN num√©rico a letra si es necesario
            const convertirAlmacen = (alm) => {
                if (!alm || alm === '' || alm === 1 || alm === '1') return '?';
                if (alm === 2 || alm === '2') return 'A';
                if (alm === 3 || alm === '3') return 'T';
                if (alm === 4 || alm === '4') return 'C';
                if (alm === 5 || alm === '5') return 'R';
                if (['?', 'A', 'T', 'C', 'R'].includes(alm)) return alm;
                return '?';
            };
            
            appData.articulos = listaFiltrada.map((r, i) => ({
                id: `a_${i}`, 
                documento: r['DOCUMENTO'], 
                codigo: r['C√ìDIGO'] || r['CODIGO'],
                articulo: r['ART√çCULO'] || r['ARTICULO'], 
                cantidad: r['CANTIDAD'] || 1, 
                almacen: convertirAlmacen(r['ALMAC√âN'] || r['ALMACEN']), 
                ean: r['EAN'] || '',
                fotoDriveLink: r['FOTO_DRIVE'] || null,
                fotoLocal: null,
                fotoSubiendo: false,
                fotoPendiente: false,
                rowNumber: r['row_number']
            }));
            appData.repartidores = ['TODOS', ...new Set(appData.entregas.map(e => e.repartidor))];
            if (appData.entregas.length > 0) appData.fecha = appData.entregas[0].dia;
            saveToLocal(); 
            renderApp();
        }

        function getWhatsAppLink(phone) {
            let num = formatPhone(phone);
            if (!num) return null;
            // Solo n√∫meros, sin + ni 00
            num = num.replace(/[^0-9]/g, '');
            return `https://wa.me/${num}`;
        }
        
        function getTelLink(phone) {
            let num = formatPhone(phone);
            if (!num) return null;
            // A√±adir + delante para llamadas internacionales
            num = num.replace(/[^0-9]/g, '');
            return `tel:+${num}`;
        }

        function getMapsLink(dir, pob, cp) { return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dir + ', ' + pob + ' ' + cp)}`; }
        function getEstadoPagoClass(estado) { return estado === '‚Ç¨' ? 'cobrar' : 'pagado'; }

        function handleFileUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const repSheet = wb.SheetNames.find(n => n.toLowerCase().includes('reparto')) || wb.SheetNames[0];
                    const listSheet = wb.SheetNames.find(n => n.toLowerCase().includes('lista') || n.toLowerCase().includes('articulo')) || wb.SheetNames[1];
                    const repData = XLSX.utils.sheet_to_json(wb.Sheets[repSheet]);
                    const listData = listSheet ? XLSX.utils.sheet_to_json(wb.Sheets[listSheet]) : [];
                    processData(repData, listData);
                } catch (err) { alert('Error al leer archivo'); }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(repData, listData) {
            appData.entregas = repData.map((r, i) => ({
                id: `e_${i}`, repartidor: r['REPARTIDOR'] || 'Sin asignar', dia: r['DIA'], hora: r['HORA'] || '',
                documento: r['DOCUMENTO'], cliente: r['CLIENTE'], direccion: r['DIRECCION'], poblacion: r['POBLACION'],
                cp: r['C.P.'] || r['CP'], vendedor: r['VENDEDOR'], observaciones: r['OBSERVACIONES'] || '',
                telefonos: [formatPhone(r['Tel1'] || r['TEL1']), formatPhone(r['Tel2'] || r['TEL2']), formatPhone(r['Tel3'] || r['TEL3'])].filter(t => t),
                estadoPago: '?', quienEntrega: 'EQ', estado: 'PENDIENTE', notas: '', importeCobrado: null
            }));
            appData.articulos = listData.map((r, i) => ({
                id: `a_${i}`, documento: r['DOCUMENTO'], codigo: r['C√ìDIGO'] || r['CODIGO'],
                articulo: r['ART√çCULO'] || r['ARTICULO'], cantidad: r['CANTIDAD'] || 1, almacen: '?', fotoLocal: null
            }));
            appData.repartidores = ['TODOS', ...new Set(appData.entregas.map(e => e.repartidor))];
            if (appData.entregas.length > 0) appData.fecha = appData.entregas[0].dia;
            saveToLocal(); renderApp();
        }

        function toggleEstadoPago(id) {
            if (!puedeEditarPago()) return;
            const e = appData.entregas.find(x => x.id === id); if (!e) return;
            const idx = ESTADOS_PAGO.indexOf(e.estadoPago);
            e.estadoPago = ESTADOS_PAGO[(idx + 1) % ESTADOS_PAGO.length];
            savePendingChange({ type: 'estadoPago', documento: e.documento, value: e.estadoPago, rowNumber: e.rowNumber });
            saveToLocal(); renderApp(); if (appData.entregaSeleccionada) renderDetail();
        }

        function toggleQuienEntrega(id) {
            const e = appData.entregas.find(x => x.id === id); if (!e) return;
            const idx = REPARTIDORES_ENTREGA.indexOf(e.quienEntrega);
            e.quienEntrega = REPARTIDORES_ENTREGA[(idx + 1) % REPARTIDORES_ENTREGA.length];
            savePendingChange({ type: 'quienEntrega', documento: e.documento, value: e.quienEntrega, rowNumber: e.rowNumber });
            saveToLocal(); renderApp(); if (appData.entregaSeleccionada) renderDetail();
        }

        function cambiarAlmacen(id, alm) {
            if (!puedeEditarAlmacen()) return;
            const a = appData.articulos.find(x => x.id === id); if (!a) return;
            a.almacen = alm;
            savePendingChange({ type: 'almacen', documento: a.documento, codigo: a.codigo, value: alm, rowNumber: a.rowNumber });
            saveToLocal(); renderProductoDetail(); renderDetail();
        }

        function toggleAlmacen(id) {
            if (!puedeEditarAlmacen()) return;
            const a = appData.articulos.find(x => x.id === id); if (!a) return;
            const idx = ALMACENES.indexOf(a.almacen);
            a.almacen = ALMACENES[(idx + 1) % ALMACENES.length];
            savePendingChange({ type: 'almacen', documento: a.documento, codigo: a.codigo, value: a.almacen, rowNumber: a.rowNumber });
            saveToLocal(); 
            renderApp();
            if (appData.entregaSeleccionada) renderDetail();
        }

        function marcarTerminado(id) {
            const e = appData.entregas.find(x => x.id === id); if (!e) return;
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            e.estado = hora;
            savePendingChange({ type: 'estado', documento: e.documento, value: hora, rowNumber: e.rowNumber });
            saveToLocal(); closeDetail(); renderApp();
        }

        function guardarNotas(id, notas) {
            const e = appData.entregas.find(x => x.id === id); if (!e) return;
            e.notas = notas;
            savePendingChange({ type: 'notas', documento: e.documento, value: notas, rowNumber: e.rowNumber });
            saveToLocal();
        }

        function abrirModalCobro(id) {
            appData.entregaParaCobro = id;
            const e = appData.entregas.find(x => x.id === id);
            document.getElementById('cobroInput').value = e?.importeCobrado || '';
            document.getElementById('cobroModal').classList.add('active');
            document.getElementById('cobroInput').focus();
        }

        function cerrarModalCobro() { document.getElementById('cobroModal').classList.remove('active'); appData.entregaParaCobro = null; }

        function confirmarCobro() {
            const imp = parseFloat(document.getElementById('cobroInput').value) || 0;
            const e = appData.entregas.find(x => x.id === appData.entregaParaCobro); if (!e) return;
            e.importeCobrado = imp;
            savePendingChange({ type: 'importeCobrado', documento: e.documento, value: imp, rowNumber: e.rowNumber });
            saveToLocal(); renderDetail(); cerrarModalCobro();
        }

        let fotoArticuloActual = null;
        let fotosPendientes = []; // Fotos pendientes de subir
        
        function tomarFoto(id) { fotoArticuloActual = id; document.getElementById('cameraInput').click(); }
        
        async function handlePhoto(ev) {
            const file = ev.target.files[0]; 
            if (!file || !fotoArticuloActual) return;
            
            const a = appData.articulos.find(x => x.id === fotoArticuloActual); 
            if (!a) return;
            
            const e = appData.entregas.find(x => x.documento === a.documento);
            const cliente = e ? e.cliente : 'Cliente';
            const producto = a.articulo;
            
            const reader = new FileReader();
            reader.onload = async function(evt) {
                const base64Data = evt.target.result;
                
                // Guardar localmente primero
                a.fotoLocal = base64Data;
                a.fotoSubiendo = true;
                saveToLocal(); 
                renderProductoDetail();
                
                // Intentar subir a Google Drive
                await subirFotoADrive(a, cliente, producto, base64Data);
            };
            reader.readAsDataURL(file);
        }
        
        async function subirFotoADrive(articulo, cliente, producto, base64Data) {
            if (!navigator.onLine) {
                // Sin conexi√≥n - guardar para despu√©s
                articulo.fotoSubiendo = false;
                articulo.fotoPendiente = true;
                fotosPendientes.push({
                    articuloId: articulo.id,
                    cliente: cliente,
                    producto: producto,
                    foto: base64Data,
                    rowNumber: articulo.rowNumber
                });
                localStorage.setItem('fotosPendientes', JSON.stringify(fotosPendientes));
                saveToLocal();
                renderProductoDetail();
                alert('‚ö†Ô∏è Sin conexi√≥n. La foto se subir√° autom√°ticamente cuando vuelva la conexi√≥n.');
                return;
            }
            
            try {
                const response = await fetch(WEBHOOK_FOTO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        foto: base64Data,
                        cliente: cliente,
                        producto: producto,
                        rowNumber: articulo.rowNumber
                    })
                });
                
                let data = await response.json();
                if (Array.isArray(data)) data = data[0];
                
                if (data.ok) {
                    articulo.fotoDriveLink = data.link;
                    articulo.fotoSubiendo = false;
                    articulo.fotoPendiente = false;
                    articulo.fotoLocal = null; // Limpiar local ya que est√° en Drive
                    saveToLocal();
                    renderProductoDetail();
                }
            } catch (err) {
                console.error('Error subiendo foto:', err);
                articulo.fotoSubiendo = false;
                articulo.fotoPendiente = true;
                fotosPendientes.push({
                    articuloId: articulo.id,
                    cliente: cliente,
                    producto: producto,
                    foto: base64Data,
                    rowNumber: articulo.rowNumber
                });
                localStorage.setItem('fotosPendientes', JSON.stringify(fotosPendientes));
                saveToLocal();
                renderProductoDetail();
                alert('‚ö†Ô∏è Error de conexi√≥n. La foto se subir√° autom√°ticamente cuando vuelva la conexi√≥n.');
            }
        }
        
        // Subir fotos pendientes cuando vuelve la conexi√≥n
        window.addEventListener('online', async () => {
            const pendientes = JSON.parse(localStorage.getItem('fotosPendientes') || '[]');
            if (pendientes.length === 0) return;
            
            for (const foto of pendientes) {
                const a = appData.articulos.find(x => x.id === foto.articuloId);
                if (a) {
                    await subirFotoADrive(a, foto.cliente, foto.producto, foto.foto);
                }
            }
            
            // Limpiar pendientes subidas
            fotosPendientes = [];
            localStorage.removeItem('fotosPendientes');
        });
        
        function descargarFoto(id) {
            const a = appData.articulos.find(x => x.id === id);
            if (!a || !a.fotoLocal) return;
            
            const e = appData.entregas.find(x => x.documento === a.documento);
            const cliente = e ? e.cliente : 'Cliente';
            const producto = a.articulo;
            const fileName = `${cliente} - ${producto}.jpg`;
            
            // Crear enlace de descarga
            const link = document.createElement('a');
            link.href = a.fotoLocal;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function borrarFoto(id) {
            const a = appData.articulos.find(x => x.id === id); if (!a) return;
            a.fotoLocal = null; 
            a.fotoDriveLink = null;
            a.fotoSubiendo = false;
            a.fotoPendiente = false;
            saveToLocal(); 
            renderProductoDetail();
        }

        function abrirVisorFoto(imgUrl) {
            const visor = document.getElementById('fotoVisor');
            const img = document.getElementById('fotoVisorImg');
            // Usar versi√≥n de mayor resoluci√≥n para el visor
            img.src = imgUrl.replace('sz=w800', 'sz=w2000');
            visor.classList.add('active');
        }

        function cerrarVisorFoto() {
            document.getElementById('fotoVisor').classList.remove('active');
        }

        async function borrarFotoDrive(id) {
            if (!confirm('¬øBorrar foto de Drive?')) return;
            
            const a = appData.articulos.find(x => x.id === id); 
            if (!a || !a.fotoDriveLink) return;
            
            try {
                // Borrar archivo de Drive
                await fetch(WEBHOOK_BORRAR_FOTO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fotoDriveLink: a.fotoDriveLink,
                        rowNumber: a.rowNumber
                    })
                });
                
                // Borrar enlace en Google Sheets
                await fetch(WEBHOOK_GUARDAR, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        cambios: [{
                            type: 'fotoDrive',
                            rowNumber: a.rowNumber,
                            value: ''
                        }]
                    })
                });
                
            } catch (err) {
                console.error('Error borrando foto:', err);
            }
            
            // Limpiar datos locales
            a.fotoDriveLink = null;
            a.fotoLocal = null;
            saveToLocal();
            renderProductoDetail();
        }

        function renderApp() {
            document.getElementById('headerDate').textContent = appData.fecha || new Date().toLocaleDateString('es-ES');
            if (appData.usuarioActual) document.getElementById('userBadgeName').textContent = appData.emailActual;
            
            // Actualizar dropdown de filtros
            const dropdown = document.getElementById('filtroDropdown');
            dropdown.innerHTML = appData.repartidores.map(r => 
                `<div class="filtro-option ${r === appData.repartidorActual ? 'active' : ''}" onclick="selectRepartidor('${r}')">${r}</div>`
            ).join('');
            
            renderMainContent(); updateTabBadges(); updateSyncIndicator();
        }
        
        function toggleFiltroDropdown() {
            const dropdown = document.getElementById('filtroDropdown');
            const arrow = document.querySelector('.header-arrow');
            dropdown.classList.toggle('visible');
            arrow.classList.toggle('open');
        }
        
        function selectRepartidor(r) { 
            appData.repartidorActual = r; 
            saveToLocal(); 
            // Cerrar dropdown
            document.getElementById('filtroDropdown').classList.remove('visible');
            document.querySelector('.header-arrow').classList.remove('open');
            renderApp(); 
        }

        function estaTerminado(estado) {
            // Si tiene formato de hora (HH:MM) o dice TERMINADO, est√° terminado
            if (!estado) return false;
            return estado === 'TERMINADO' || /^\d{2}:\d{2}$/.test(estado);
        }

        function renderMainContent() {
            const c = document.getElementById('mainContent');
            let entregas = appData.entregas.filter(e => {
                const mR = appData.repartidorActual === 'TODOS' || e.repartidor === appData.repartidorActual;
                const terminado = estaTerminado(e.estado);
                const mT = appData.tabActual === 'reparto' ? !terminado : terminado;
                return mR && mT;
            });
            if (appData.tabActual === 'servicios') { c.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg><p>Pr√≥ximamente</p></div>`; return; }
            
            if (appData.tabActual === 'lista') { 
                c.innerHTML = `
                    <div class="scanner-section">
                        <h3>Escanear c√≥digo</h3>

                        <div id="scanner-container"></div>
                        <div id="resultadoEAN"></div>
                        <button class="btn-glide" onclick="iniciarScanner()" id="btnIniciarScanner">
                            ${SVG_CAMERA} Iniciar c√°mara
                        </button>
                    </div>
                `;
                // Iniciar scanner autom√°ticamente
                setTimeout(iniciarScanner, 500);
                return; 
            }
            if (entregas.length === 0) { c.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><p>${appData.tabActual === 'reparto' ? 'No hay entregas pendientes' : 'No hay entregas terminadas'}</p></div>`; return; }
            entregas.sort((a, b) => ((a.hora || '').split(' - ')[0] || '99').localeCompare((b.hora || '').split(' - ')[0] || '99'));
            const grupos = {}; entregas.forEach(e => { const h = e.hora || 'Sin hora'; if (!grupos[h]) grupos[h] = []; grupos[h].push(e); });
            let html = ''; Object.entries(grupos).forEach(([h, items]) => { html += `<div class="time-group"><div class="time-header">${h}</div>${items.map(e => renderEntregaCard(e)).join('')}</div>`; });
            c.innerHTML = html;
        }

        function formatCantidad(cantidad) {
            return (cantidad > 1 || cantidad < 0) ? `<span class="cantidad-multiple">${cantidad}</span> ` : '';
        }

        function renderEntregaCard(e) {
            const obs = e.observaciones || '';
            const canEdit = puedeEditarPago();
            const esAdmin = isAdmin();
            const arts = esAdmin ? appData.articulos.filter(a => a.documento === e.documento) : [];
            
            let articulosHtml = '';
            if (esAdmin && arts.length > 0) {
                articulosHtml = `<div class="articulos-preview">${arts.map(a => `<div class="articulo-mini"><span class="articulo-almacen-mini" onclick="event.stopPropagation(); toggleAlmacen('${a.id}')">${a.almacen}</span><span class="articulo-nombre-mini">${formatCantidad(a.cantidad)}${a.articulo}</span></div>`).join('')}</div>`;
            }
            
            return `<div class="entrega-card"><div class="entrega-row">
                <div class="status-icon ${getEstadoPagoClass(e.estadoPago)}" onclick="event.stopPropagation(); ${canEdit ? `toggleEstadoPago('${e.id}')` : ''}" style="${canEdit ? 'cursor:pointer' : 'cursor:default'}">${e.estadoPago}</div>
                <div class="entrega-info" onclick="openDetail('${e.id}')"><div class="cliente-nombre">${e.cliente}</div><div class="cliente-direccion">${e.direccion}</div><div class="cliente-vendedor">${e.documento} - ${e.vendedor}</div>${obs ? `<div class="observaciones-preview">${obs}</div>` : ''}${articulosHtml}</div>
                <div class="repartidor-icon" onclick="event.stopPropagation(); toggleQuienEntrega('${e.id}')">${e.quienEntrega === 'EQ' ? SVG_EQUIPO : e.quienEntrega}</div>
                <div class="arrow-icon" onclick="openDetail('${e.id}')">‚Ä∫</div></div></div>`;
        }

        function updateTabBadges() {
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab${appData.tabActual.charAt(0).toUpperCase() + appData.tabActual.slice(1)}`)?.classList.add('active');
        }

        function openDetail(id) { appData.entregaSeleccionada = id; renderDetail(); document.getElementById('detailView').classList.add('active'); }
        function closeDetail() { document.getElementById('detailView').classList.remove('active'); appData.entregaSeleccionada = null; }

        function mostrarOpcionesTelefono(tel) {
            const telLink = getTelLink(tel);
            const waLink = getWhatsAppLink(tel);
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="text-align:center;">
                    <h3 style="margin-bottom:20px;">üìû ${tel}</h3>
                    <a href="${telLink}" class="btn-glide" style="margin-bottom:10px;display:block;">üìû Llamar</a>
                    <a href="${waLink}" target="_blank" class="btn-glide" style="margin-bottom:10px;display:block;">üí¨ WhatsApp</a>
                    <button class="btn-glide" style="background:#f0f0f0;color:#333;" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (ev) => { if (ev.target === modal) modal.remove(); };
        }

        function renderDetail() {
            const e = appData.entregas.find(x => x.id === appData.entregaSeleccionada); if (!e) return;
            document.getElementById('detailHeaderText').textContent = e.hora;
            const arts = appData.articulos.filter(a => a.documento === e.documento);
            const tel = e.telefonos[0] || '';
            const maps = getMapsLink(e.direccion, e.poblacion, e.cp);
            const canEditAlm = puedeEditarAlmacen();
            let html = `<div class="detail-location"><div class="detail-zona">${e.poblacion} ${e.cp}</div><div class="detail-direccion" onclick="window.open('${maps}','_blank')">${e.direccion}</div><div class="detail-cliente">${e.cliente}</div>${tel ? `<div class="detail-telefono" onclick="mostrarOpcionesTelefono(&quot;${tel}&quot;)">Tel: ${tel}</div>` : ''}<div class="detail-vendedor">Vendedor: ${e.vendedor}</div></div>`;
            if (e.observaciones) html += `<div class="observaciones-box">${e.observaciones}</div>`;
            html += `<button class="btn-glide" onclick="abrirScannerDesdeDetalle()">${SVG_BARCODE} Escanear</button>`;
            html += arts.map(a => `<div class="producto-card"><div class="producto-header"><div class="producto-almacen-icon" onclick="event.stopPropagation(); ${canEditAlm ? `toggleAlmacen('${a.id}')` : ''}" style="${canEditAlm ? 'cursor:pointer' : ''}">${a.almacen}</div><div class="producto-info-row" onclick="openProductoDetail('${a.id}')"><div class="producto-qty">${(a.cantidad > 1 || a.cantidad < 0) ? `<span style="color:var(--accent-red)">${a.cantidad}</span>` : ''}</div><div class="producto-nombre">${a.articulo}</div></div></div></div>`).join('');
            if (e.estadoPago === '‚Ç¨' || e.estadoPago === '?') html += `<button class="btn-glide" onclick="abrirModalCobro('${e.id}')">${SVG_MONEY} Cobrar</button>`;
            if (e.importeCobrado) html += `<div class="importe-cobrado"><span>Importe cobrado:</span><strong>${e.importeCobrado.toFixed(2)} ‚Ç¨</strong></div>`;
            html += `<div class="notas-section"><div class="notas-label">Notas</div><textarea class="notas-input" placeholder="A√±adir notas..." onchange="guardarNotas('${e.id}', this.value)">${e.notas || ''}</textarea></div>`;
            html += `<button class="btn-glide" onclick="marcarTerminado('${e.id}')">${SVG_CHECK} Terminado</button>`;
            document.getElementById('detailContent').innerHTML = html;
        }

        function openProductoDetail(id) { appData.productoSeleccionado = id; renderProductoDetail(); document.getElementById('productoDetailView').classList.add('active'); }
        function closeProductoDetail() { document.getElementById('productoDetailView').classList.remove('active'); appData.productoSeleccionado = null; }

        function renderProductoDetail() {
            const a = appData.articulos.find(x => x.id === appData.productoSeleccionado); if (!a) return;
            const e = appData.entregas.find(x => x.documento === a.documento);
            let html = `${(a.cantidad > 1 || a.cantidad < 0) ? `<div class="producto-detail-qty" style="color: var(--accent-red)">${a.cantidad}</div>` : ''}<div class="producto-detail-nombre">${a.articulo}</div><div class="producto-detail-almacen">${ALMACEN_NOMBRES[a.almacen]}</div>`;
            if (e) html += `<div class="producto-detail-info">${e.hora} ${e.cliente}</div><div class="producto-detail-info">${e.direccion}</div>`;
            
            // Estado de la foto
            if (a.fotoDriveLink) {
                // Foto ya subida a Drive - mostrar directamente
                // Extraer el ID del archivo de Drive y usar formato de thumbnail
                const driveId = a.fotoDriveLink.match(/\/d\/([^\/]+)/)?.[1] || '';
                const imgUrl = driveId ? `https://drive.google.com/thumbnail?id=${driveId}&sz=w800` : a.fotoDriveLink;
                html += `<div class="foto-status foto-ok">‚úì Foto subida a Drive</div>`;
                html += `<img src="${imgUrl}" class="foto-preview" onclick="abrirVisorFoto('${imgUrl}')" onerror="this.style.display='none'">`;
                html += `<button class="btn-glide btn-borrar" onclick="borrarFotoDrive('${a.id}')">üóëÔ∏è Borrar foto</button>`;
            } else if (a.fotoSubiendo) {
                // Subiendo foto
                html += `<div class="foto-status foto-subiendo">‚è≥ Subiendo foto...</div>`;
                if (a.fotoLocal) html += `<img src="${a.fotoLocal}" class="foto-preview">`;
            } else if (a.fotoPendiente) {
                // Foto pendiente de subir (sin conexi√≥n)
                html += `<div class="foto-status foto-pendiente">‚ö†Ô∏è Foto pendiente de subir (sin conexi√≥n)</div>`;
                if (a.fotoLocal) html += `<img src="${a.fotoLocal}" class="foto-preview">`;
            } else if (a.fotoLocal) {
                // Foto local sin subir
                html += `<img src="${a.fotoLocal}" class="foto-preview">`;
            } else {
                // Sin foto - mostrar bot√≥n para tomar
                html += `<button class="btn-glide btn-foto" onclick="tomarFoto('${a.id}')">${SVG_CAMERA} Tomar una foto</button>`;
            }
            
            html += `<div class="notas-section"><div class="notas-label">Notas</div><textarea class="notas-input" placeholder="Notas del producto..."></textarea></div>`;
            document.getElementById('productoDetailContent').innerHTML = html;
        }
        
        async function showTab(t) { 
            // Detener scanner si cambiamos de pesta√±a
            if (window.html5QrCode && scannerActivo) {
                try {
                    await window.html5QrCode.stop();
                    scannerActivo = false;
                } catch (e) {
                    console.log('Scanner ya detenido');
                }
            }
            appData.tabActual = t; 
            saveToLocal(); 
            renderApp(); 
        }

        let scannerActivo = false;

        function abrirScannerDesdeDetalle() {
            closeDetail();
            showTab('lista');
            setTimeout(() => iniciarScanner(), 300);
        }

        async function iniciarScanner() {
            const container = document.getElementById('scanner-container');
            const btnIniciar = document.getElementById('btnIniciarScanner');
            
            if (scannerActivo) return;
            
            if (btnIniciar) btnIniciar.style.display = 'none';
            
            // Crear nueva instancia si no existe
            if (!window.html5QrCode) {
                window.html5QrCode = new Html5Qrcode("scanner-container");
            }
            
            try {
                await window.html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    (decodedText) => {
                        procesarCodigoEscaneado(decodedText);
                    },
                    (errorMessage) => {
                        // Ignorar errores de escaneo continuo
                    }
                );
                scannerActivo = true;
            } catch (err) {
                console.error('Error al iniciar c√°mara:', err);
                if (container) {
                    container.innerHTML = '<p style="color: red; padding: 20px;">Error al acceder a la c√°mara. Aseg√∫rate de dar permisos.</p>';
                }
                if (btnIniciar) btnIniciar.style.display = 'block';
            }
        }

        // Variables para debounce del scanner
        let ultimoTiempoEscaneo = 0;
        const DEBOUNCE_MS = 3000; // 3 segundos entre escaneos

        function procesarCodigoEscaneado(codigo) {
            const ahora = Date.now();
            
            // Evitar procesar cualquier c√≥digo en menos de 3 segundos
            if (ahora - ultimoTiempoEscaneo < DEBOUNCE_MS) {
                console.log('Debounce: ignorando escaneo');
                return;
            }
            
            // Actualizar tiempo
            ultimoTiempoEscaneo = ahora;
            
            console.log('C√≥digo escaneado:', codigo);
            
            const resultado = document.getElementById('resultadoEAN');
            
            // Detectar si es URL de EPREL (case insensitive)
            if (codigo.toLowerCase().includes('eprel.ec.europa.eu')) {
                console.log('Detectado QR EPREL');
                procesarUrlEPREL(codigo.toLowerCase());
                return;
            }
            
            // Validar si es un EAN (solo d√≠gitos, 8 o 13 caracteres)
            const esEAN = /^\d{8}$|^\d{13}$/.test(codigo);
            
            if (!esEAN) {
                resultado.innerHTML = `
                    <div class="resultado-no-encontrado">
                        <h4>‚úó No es un EAN</h4>
                        <p>El c√≥digo escaneado no es un c√≥digo de barras v√°lido</p>
                    </div>
                `;
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                return;
            }
            
            // Buscar EAN en la lista
            const articulo = appData.articulos.find(a => a.ean === codigo);
            
            if (articulo) {
                const entrega = appData.entregas.find(e => e.documento === articulo.documento);
                
                resultado.innerHTML = `
                    <div class="resultado-encontrado">
                        <h4>‚úì Encontrado en la lista</h4>
                        <div class="resultado-articulo">${(articulo.cantidad > 1 || articulo.cantidad < 0) ? `<span style="color: var(--accent-red)">${articulo.cantidad}</span> ` : ''}${articulo.articulo}</div>
                        ${entrega ? `
                            <div class="resultado-cliente">${entrega.cliente}</div>
                            <div class="resultado-info">${entrega.direccion}</div>
                            <div class="resultado-info">${entrega.hora} - ${entrega.documento}</div>
                        ` : ''}
                    </div>
                `;
                
                if (navigator.vibrate) navigator.vibrate(200);
            } else {
                resultado.innerHTML = `
                    <div class="resultado-no-encontrado">
                        <h4>‚úó No encontrado</h4>
                        <p>El EAN ${codigo} no est√° en la lista de reparto de hoy</p>
                    </div>
                `;
                
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
        }

        async function procesarUrlEPREL(url) {
            const resultado = document.getElementById('resultadoEAN');
            resultado.innerHTML = '<div class="foto-status foto-subiendo">‚è≥ Consultando EPREL...</div>';

            try {
                const response = await fetch(WEBHOOK_EXTRAER_MODELO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                let data = await response.json();
                if (Array.isArray(data)) data = data[0];

                if (data.ok && data.modelo) {
                    const modelo = data.modelo.toUpperCase();
                    const articulo = appData.articulos.find(a => 
                        a.articulo.toUpperCase().includes(modelo) || 
                        a.codigo?.toUpperCase().includes(modelo)
                    );

                    if (articulo) {
                        const entrega = appData.entregas.find(e => e.documento === articulo.documento);
                        resultado.innerHTML = `
                            <div class="resultado-encontrado">
                                <h4>‚úì Modelo ${modelo} encontrado</h4>
                                <div class="resultado-articulo">${(articulo.cantidad > 1 || articulo.cantidad < 0) ? `<span style="color: var(--accent-red)">${articulo.cantidad}</span> ` : ''}${articulo.articulo}</div>
                                ${entrega ? `
                                    <div class="resultado-cliente">${entrega.cliente}</div>
                                    <div class="resultado-info">${entrega.direccion}</div>
                                    <div class="resultado-info">${entrega.hora} - ${entrega.documento}</div>
                                ` : ''}
                            </div>
                        `;
                        if (navigator.vibrate) navigator.vibrate(200);
                    } else {
                        resultado.innerHTML = `
                            <div class="resultado-no-encontrado">
                                <h4>‚úó Modelo ${modelo} no encontrado</h4>
                                <p>Este modelo no est√° en la lista de reparto de hoy</p>
                            </div>
                        `;
                        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    }
                } else {
                    resultado.innerHTML = `
                        <div class="resultado-no-encontrado">
                            <h4>‚úó No se pudo extraer el modelo</h4>
                            <p>Intenta de nuevo o verifica el QR</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error:', err);
                resultado.innerHTML = `
                    <div class="resultado-no-encontrado">
                        <h4>‚úó Error de conexi√≥n</h4>
                        <p>No se pudo consultar EPREL</p>
                    </div>
                `;
            }
        }

        async function init() {
            const has = loadFromLocal();
            if (!has || !appData.usuarioActual) {
                showLogin();
            } else {
                hideLogin();
                await cargarDatosDesdesheets();
                renderApp();
            }
        }

        init();
    </script>
</body>
</html>
